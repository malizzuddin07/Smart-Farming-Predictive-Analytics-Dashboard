{% extends "_base.html" %}

{% block title %}My Sessions{% endblock %}

{% block content %}
<style>
    /* Styles for new dashboard features */
    .filter-search-form {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
    }
    .filter-search-form input[type="text"] {
        flex-grow: 1;
        min-width: 250px;
    }
    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .btn-danger:hover {
        background-color: #c82333;
    }
    .session-card {
        transition: box-shadow 0.2s;
        display: flex;
        flex-direction: column; /* Makes card layout vertical */
    }
    .session-card-content {
        flex-grow: 1; /* Pushes actions to the bottom */
        padding: 20px;
    }
    .session-card-content a {
        text-decoration: none;
        color: inherit;
    }
    .session-card-content a:hover h3 {
        color: #0056b3; /* Or your theme's primary color */
    }
    .session-card-content h3 {
        margin-top: 0;
    }
    .session-card-content p {
        margin: 8px 0;
    }
    .card-actions {
        padding: 15px 20px;
        background: #fdfdfd;
        border-top: 1px solid #eee;
        text-align: right;
    }
    .card-actions form {
        margin: 0;
    }

    /* Style for harvested sessions */
    .session-card.harvested {
        background-color: #f4f8f4;
        border-color: #d4e8d4;
    }
    .badge-harvested {
        font-weight: bold;
        color: #28a745;
        margin-left: 8px;
    }
</style>

<div class="container">

    <div class="card" style="background-color: #e8f5e9; border-left: 5px solid #4CAF50;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div>
                <h2 style="border-bottom: none; padding-bottom: 0; margin-bottom: 10px;">My Planting Sessions</h2>
                <p style="margin: 0; font-size: 1.1em;">Select a session to view details or create a new one.</p>
            </div>
            <a href="{{ url_for('new_session_form') }}" class="btn btn-primary btn-lg">
                + New Planting Session
            </a>
        </div>
    </div>

    <div class="card" style="margin-bottom: 25px;">
        <form method="GET" action="{{ url_for('dashboard_home') }}" class="filter-search-form">
            <input type="text" name="search" value="{{ current_search or '' }}" placeholder="Search by session name or location...">
            
            <select name="filter_by" onchange="this.form.submit()">
                <option value="ongoing" {% if current_filter == 'ongoing' %}selected{% endif %}>Ongoing</option>
                <option value="harvested" {% if current_filter == 'harvested' %}selected{% endif %}>Harvested</option>
                <option value="all" {% if current_filter == 'all' %}selected{% endif %}>Show All</option>
            </select>
            
            <button type="submit" class="btn">Search</button>
        </form>
    </div>

    <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
        {% if sessions %}
            {% for session in sessions %}
            
            {% set is_harvested = (session.expected_harvest_date and session.expected_harvest_date < today) %}
            
            <div class="card session-card {% if is_harvested %}harvested{% endif %}">
                
                <div class="session-card-content">
                    <a href="{{ url_for('session_dashboard', session_id=session.session_id) }}">
                        <h3>{{ session.session_name }}</h3>
                    </a>
                    <p><strong>üìç Location:</strong> {{ session.location }}</p>
                    <p><strong>üåæ Size:</strong> {{ session.field_size }} ha</p>
                    <p><strong>üóìÔ∏è Planted:</strong> {{ session.planting_date.strftime('%d %b %Y') }}</p>
                    <p><strong>‚úÖ Harvest:</strong> {{ session.expected_harvest_date.strftime('%d %b %Y') }}
                       {% if is_harvested %}
                         <span class="badge-harvested">(Harvested)</span>
                       {% endif %}
                    </p>
                    <p><strong>Yield:</strong> {{ "%.2f"|format(session.predicted_yield_per_ha) }} t/ha</p>
                </div>
                
                <div class="card-actions">
                    <form action="{{ url_for('delete_session', session_id=session.session_id) }}" method="POST" 
                          onsubmit="return confirm('Are you sure you want to delete this session? This will permanently delete all its predictions and workflow tasks.');">
                        <button type="submit" class="btn-danger">Delete Session</button>
                    </form>
                </div>

            </div>
            {% endfor %}
        {% else %}
            <div class="card" style="grid-column: 1 / -1; text-align: center;">
                <h3>No planting sessions found.</h3>
                <p>{% if current_search or current_filter != 'all' %}Try adjusting your search or filter.{% else %}Click the button above to create your first one!{% endif %}</p>
            </div>
        {% endif %}
    </div>

</div>
{% endblock %}