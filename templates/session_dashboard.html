{% extends "_base.html" %}

{% block title %}{{ session_details.session_name or 'Session Dashboard' }}{% endblock %}

{% block content %}
<style>
    /* --- RESPONSIVE DASHBOARD GRID --- */
    .dashboard-grid {
        display: grid;
        gap: 25px;
        /* Default Desktop: 2/3 for Main Content, 1/3 for Workflow */
        grid-template-columns: 2fr 1fr; 
    }

    /* Mobile Rule: When screen is small, stack them (1 column only) */
    @media (max-width: 900px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="container">

    {% if alert_memo %}
    <div class="message {{ alert_memo.level }}" style="border-left: 6px solid; padding: 15px; margin-bottom: 25px;">
        <h3 style="margin-top: 0; border: none; font-size: 1.2em;">
            {% if alert_memo.level == 'danger' %}üõë 
            {% elif alert_memo.level == 'warning' %}‚ö†Ô∏è 
            {% else %}‚úÖ {% endif %}
            {{ alert_memo.title }}
        </h3>
        <p style="margin: 0; font-size: 1.05em;">{{ alert_memo.message }}</p>
    </div>
    {% endif %}

    <div class="card" style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h2>{{ session_details.session_name }}</h2>
            <a href="{{ url_for('edit_session_form', session_id=session_details.session_id) }}" class="btn">Edit Session</a>
        </div>

        <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 20px;">
            <div class="stat-card">
                <h4>üìç Location</h4>
                <p>{{ session_details.location }}</p>
            </div>
            
            <div class="stat-card" title="Predicted Yield is an estimate with a +/- 10% variance.">
                <h4>üåæ Predicted Yield</h4>
                <p style="font-size: 1.2em; font-weight: bold; color: #2e7d32;">
                    {{ "%.2f"|format(session_details.predicted_total_yield) }} t
                </p>
                <small style="color: #777;">({{ "%.2f"|format(session_details.predicted_yield_per_ha) }} t/ha)</small>
            </div>
            
            <div class="stat-card">
                <h4>üóìÔ∏è Planting</h4>
                <p>{{ session_details.planting_date.strftime('%d %b') }}</p>
            </div>
            <div class="stat-card">
                <h4>‚úÖ Harvest</h4>
                <p>{{ session_details.expected_harvest_date.strftime('%d %b') }}</p>
            </div>
        </div>
    </div>
    
    <div class="dashboard-grid">

        <div style="display: flex; flex-direction: column; gap: 25px;">
            
            {% if weather_forecast %}
            <div class="card">
                <h2>üå¶Ô∏è 3-Day Forecast</h2>
                <div class="forecast-container" style="display: flex; gap: 10px; justify-content: space-between; flex-wrap: wrap;">
                    {% for day in weather_forecast %}
                    <div class="forecast-day" style="background: #f1f8e9; padding: 10px; border-radius: 8px; flex: 1; text-align: center; min-width: 100px;">
                         <p style="font-weight: bold; color: #2e7d32; margin: 0;">{{ day.label }}</p>
                         <small>{{ day.date }}</small>
                         
                         {% if day.icon %}
                            <div style="margin: 5px 0;"><img src="https:{{ day.icon }}" alt="Icon" style="width: 40px;"></div>
                         {% endif %}
                         
                         <div style="font-size: 0.9em;">
                            <span style="color: #d32f2f;">{{ day.temp_max }}¬∞</span> / 
                            <span style="color: #1976d2;">{{ day.temp_min }}¬∞</span>
                         </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="card">
                <h2>‚òÄÔ∏è Solar Radiation History</h2>
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="sradHistoryChart"></canvas>
                </div>
            </div>

            {% if input_breakdown and input_breakdown.raw %}
            <div class="card">
                <h4>Prediction Inputs</h4>
                <div class="input-breakdown" style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr><th>Feature</th><th>Value</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            {% for key, raw_value in input_breakdown.raw.items() %}
                                <tr>
                                    <td>{{ key.replace('_BOHOR', '').replace(' (meq/100)', '') | replace('TotalSRAD', 'Solar Rad') }}</td>
                                    <td>{{ "%.2f"|format(raw_value) if raw_value else 'N/A' }}</td>
                                    <td id="optimal-{{ key | replace(' (meq/100)', '') }}"></td> 
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="card" style="grid-column: span 1; height: fit-content;">
            <h2>üìã Workflow</h2>
            
            <form method="GET" action="{{ url_for('session_dashboard', session_id=session_details.session_id) }}" style="margin-bottom: 15px;">
                <select name="sort_by" onchange="this.form.submit()" style="width: 100%; padding: 8px;">
                    <option value="default" {% if current_sort == 'default' %}selected{% endif %}>Sort: Priority</option>
                    <option value="in_process" {% if current_sort == 'in_process' %}selected{% endif %}>In Process</option>
                    <option value="soon" {% if current_sort == 'soon' %}selected{% endif %}>Coming Soon</option>
                    <option value="completed" {% if current_sort == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </form>
            
            <div style="max-height: 1000px; overflow-y: auto; padding-right: 5px;">
                {% if not tasks %}
                    <p>No tasks found.</p>
                {% endif %}
                
                {% for task in tasks %}
                <div class="card {{ task.status }}" style="box-shadow: none; border: 1px solid #eee; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h4 style="margin: 0; border: none; font-size: 1em;">{{ task.task_name or 'Unnamed Task' }}</h4>
                        <span style="font-size: 0.8em; background: #eee; padding: 2px 6px; border-radius: 4px;">{{ task.start_date.strftime('%d %b') }}</span>
                    </div>
                    
                    <p style="font-size: 0.85em; margin: 5px 0 10px 0; color: #666;">Status: {{ task.status|capitalize }}</p>

                    <form method="POST" action="{{ url_for('update_step', sort_by=current_sort) }}" id="form_{{ task.id }}">
                        <input type="hidden" name="task_id" value="{{ task.id }}">
                        <input type="hidden" name="session_id" value="{{ session_details.session_id }}">
                        
                        {% set is_disabled = (task.status == 'completed') %}
                        
                        <select name="status" style="margin-bottom: 8px; font-size: 0.9em; padding: 5px;" {% if is_disabled %}disabled{% endif %}>
                            <option value="soon" {% if task.status == 'soon' %}selected{% endif %}>Waiting</option>
                            <option value="in_process" {% if task.status == 'in_process' %}selected{% endif %}>In Process</option>
                            <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Done</option>
                        </select>

                        {% if not is_disabled %}
                            <button type="submit" class="btn update-btn" style="width: 100%; font-size: 0.9em; padding: 6px;">Update</button>
                        {% else %}
                             <button type="button" class="btn" style="width: 100%; font-size: 0.9em; padding: 6px; background: #ccc; cursor: default;">Completed</button>
                        {% endif %}
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div> 

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. SRAD CHART
        const sradCtx = document.getElementById('sradHistoryChart');
        let historicalSradData;
        try { historicalSradData = {{ historical_srad_json | safe }}; } 
        catch(e) { historicalSradData = {}; }
        
        if (sradCtx && historicalSradData && historicalSradData.dates && historicalSradData.dates.length > 0) {
            new Chart(sradCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: historicalSradData.dates,
                    datasets: [{
                        label: 'Solar Rad (kWh/m¬≤)',
                        data: historicalSradData.values,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 6 } },
                        y: { beginAtZero: true } 
                    }
                }
            });
        } else if (sradCtx) {
             sradCtx.style.display = 'none';
        }

        // 2. OPTIMAL RANGES (Optional Logic)
        let normParams;
        try { normParams = {{ norm_params_json | safe }}; } 
        catch(e) { normParams = {}; }
        
        for (const [key, params] of Object.entries(normParams)) {
            let cleanKey = key.replace(' (meq/100)', '');
            const element = document.getElementById(`optimal-${cleanKey}`);
            if (element && params.optimal) {
                element.innerHTML = `<span style="color:green; font-size:0.8em;">${params.optimal[0]} - ${params.optimal[1]}</span>`;
            }
        }
    });
</script>

{% endblock %}